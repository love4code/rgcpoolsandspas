<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Library - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    /* Mobile sidebar styles */
    @media (max-width: 767.98px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 1050;
        width: 250px !important;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
      }
      
      .sidebar-overlay.show {
        display: block;
      }
      
      main {
        margin-left: 0 !important;
        width: 100% !important;
      }
    }
    
    /* Desktop styles */
    @media (min-width: 768px) {
      .sidebar {
        transform: translateX(0) !important;
      }
      
      .sidebar-toggle {
        display: none;
      }
      
      .sidebar-overlay {
        display: none !important;
      }
    }
    
    .sidebar-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1051;
      background-color: #212529;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .sidebar-toggle:hover {
      background-color: #495057;
    }
    
    .sidebar-close {
      display: none;
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1052;
    }
    
    @media (max-width: 767.98px) {
      .sidebar-close {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile sidebar toggle button -->
  <button class="sidebar-toggle" id="sidebarToggle" type="button">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar vh-100 position-fixed" id="adminSidebar">
        <button class="sidebar-close" id="sidebarClose" type="button">
          <i class="bi bi-x-lg"></i>
        </button>
        <div class="position-sticky pt-3">
          <h5 class="text-light px-3 mb-3">Admin Panel</h5>
          <%- include('../../partials/admin-sidebar', { inquiryCount: 0 }) %>
        </div>
      </nav>
      
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" id="adminMain">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Media Library</h1>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="bi bi-upload"></i> Upload Images
          </button>
        </div>

        <div class="row g-3">
          <% media.forEach(item => { %>
            <div class="col-md-3">
              <div class="card">
                <img src="/admin/media/image/<%= item._id %>/thumbnail?t=<%= Date.now() %>" class="card-img-top" alt="<%= item.alt || item.originalName %>" id="img-<%= item._id %>">
                <div class="card-body">
                  <div class="mb-2">
                    <input type="text" class="form-control form-control-sm mb-1" 
                           id="title-<%= item._id %>" 
                           placeholder="Title" 
                           value="<%= item.title || '' %>"
                           onblur="updateMedia('<%= item._id %>', 'title', this.value)">
                    <input type="text" class="form-control form-control-sm" 
                           id="alt-<%= item._id %>" 
                           placeholder="Alt text" 
                           value="<%= item.alt || '' %>"
                           onblur="updateMedia('<%= item._id %>', 'alt', this.value)">
                  </div>
                  <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                    <button type="button" class="btn btn-outline-primary" 
                            onclick="flipImage('<%= item._id %>', 'horizontal')" 
                            title="Flip Horizontal">
                      <i class="bi bi-arrow-left-right"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" 
                            onclick="flipImage('<%= item._id %>', 'vertical')" 
                            title="Flip Vertical">
                      <i class="bi bi-arrow-up-down"></i>
                    </button>
                  </div>
                  <button class="btn btn-sm btn-danger w-100" onclick="deleteMedia('<%= item._id %>')">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          <% }); %>
        </div>

        <% if (totalPages > 1) { %>
          <nav class="mt-4">
            <ul class="pagination justify-content-center">
              <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
              <% } %>
            </ul>
          </nav>
        <% } %>
      </main>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Images</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="images" class="form-label">Select Images</label>
              <input type="file" class="form-control" id="images" name="images" multiple accept="image/*" required>
            </div>
            <div class="progress" style="display: none;" id="progressBar">
              <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="uploadImages()">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Mobile sidebar toggle functionality
    (function() {
      const sidebar = document.getElementById('adminSidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      
      function openSidebar() {
        sidebar.classList.add('show');
        sidebarOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSidebar() {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
      }
      
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', openSidebar);
      }
      
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }
      
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }
      
      // Close sidebar when clicking on a link (mobile only)
      if (window.innerWidth <= 767.98) {
        const sidebarLinks = sidebar.querySelectorAll('a');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', closeSidebar);
        });
      }
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth > 767.98) {
          closeSidebar();
        }
      });
    })();
    
    async function uploadImages() {
      const form = document.getElementById('uploadForm');
      const formData = new FormData(form);
      const progressBar = document.getElementById('progressBar');
      const progressBarFill = progressBar.querySelector('.progress-bar');
      
      progressBar.style.display = 'block';
      progressBarFill.style.width = '0%';

      try {
        const response = await fetch('/admin/media/upload', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          alert('Upload error: Server returned an error page. Please check your authentication and try again.');
          progressBar.style.display = 'none';
          return;
        }

        const result = await response.json();
        
        if (result.success) {
          progressBarFill.style.width = '100%';
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          alert('Upload failed: ' + (result.error || 'Unknown error'));
          progressBar.style.display = 'none';
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload error: ' + (error.message || 'Failed to upload images. Please try again.'));
        progressBar.style.display = 'none';
      }
    }

    async function updateMedia(id, field, value) {
      try {
        const response = await fetch(`/admin/media/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ [field]: value })
        });

        const result = await response.json();
        if (!result.success) {
          alert('Update failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Update error: ' + error.message);
      }
    }

    async function flipImage(id, direction) {
      try {
        const response = await fetch(`/admin/media/${id}/flip`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ direction: direction })
        });

        const result = await response.json();
        if (result.success) {
          // Update image with cache busting
          const img = document.getElementById(`img-${id}`);
          if (img) {
            img.src = `/admin/media/image/${id}/thumbnail?t=${Date.now()}`;
          }
        } else {
          alert('Flip failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Flip error:', error);
        alert('Flip error: ' + error.message);
      }
    }

    async function deleteMedia(id) {
      if (!confirm('Are you sure you want to delete this media?')) return;
      
      try {
        const response = await fetch(`/admin/media/${id}`, {
          method: 'DELETE',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const result = await response.json();
        if (result.success) {
          window.location.reload();
        } else {
          alert('Delete failed');
        }
      } catch (error) {
        alert('Delete error: ' + error.message);
      }
    }
  </script>
</body>
</html>

