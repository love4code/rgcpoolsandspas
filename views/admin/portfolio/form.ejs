<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= item ? 'Edit' : 'New' %> Portfolio - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    /* Mobile sidebar styles */
    @media (max-width: 767.98px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 1050;
        width: 250px !important;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
      }
      
      .sidebar-overlay.show {
        display: block;
      }
      
      main {
        margin-left: 0 !important;
        width: 100% !important;
      }
    }
    
    /* Desktop styles */
    @media (min-width: 768px) {
      .sidebar {
        transform: translateX(0) !important;
      }
      
      .sidebar-toggle {
        display: none;
      }
      
      .sidebar-overlay {
        display: none !important;
      }
    }
    
    .sidebar-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1051;
      background-color: #212529;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .sidebar-toggle:hover {
      background-color: #495057;
    }
    
    .sidebar-close {
      display: none;
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1052;
    }
    
    @media (max-width: 767.98px) {
      .sidebar-close {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile sidebar toggle button -->
  <button class="sidebar-toggle" id="sidebarToggle" type="button">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar vh-100 position-fixed" id="adminSidebar">
        <button class="sidebar-close" id="sidebarClose" type="button">
          <i class="bi bi-x-lg"></i>
        </button>
        <div class="position-sticky pt-3">
          <h5 class="text-light px-3 mb-3">Admin Panel</h5>
          <%- include('../../partials/admin-sidebar', { inquiryCount: 0 }) %>
        </div>
      </nav>
      
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" id="adminMain">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2"><%= item ? 'Edit' : 'New' %> Portfolio Item</h1>
          <a href="/admin/portfolio" class="btn btn-secondary">Back</a>
        </div>

        <% if (typeof success !== 'undefined' && success.length > 0) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success[0] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>
        <% if (typeof error !== 'undefined' && error.length > 0) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error[0] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <form action="<%= item ? `/admin/portfolio/${item._id}` : '/admin/portfolio' %>" method="POST">
          <div class="row">
            <div class="col-md-8">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-control" name="title" value="<%= item ? item.title : '' %>" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description *</label>
                    <textarea class="form-control" name="description" rows="5" required><%= item ? item.description : '' %></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">SEO Title</label>
                    <input type="text" class="form-control" name="seoTitle" value="<%= item ? item.seoTitle || '' : '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">SEO Description</label>
                    <textarea class="form-control" name="seoDescription" rows="3"><%= item ? item.seoDescription || '' : '' %></textarea>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="featured" <%= item && item.featured ? 'checked' : '' %>>
                    <label class="form-check-label">Featured on Home Page</label>
                  </div>
                  <% if (item) { %>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="active" <%= item.active ? 'checked' : '' %>>
                      <label class="form-check-label">Active</label>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card mb-3">
                <div class="card-body">
                  <h5>Featured Image</h5>
                  <div class="mb-3">
                    <label class="form-label">Select from Media Library</label>
                    <div class="dropdown w-100">
                      <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="featuredImageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="featuredImageButtonText">
                          <% if (item && item.featuredImage) { %>
                            Selected: <%= item.featuredImage.title || item.featuredImage.originalName || 'Image' %>
                          <% } else { %>
                            Select an image
                          <% } %>
                        </span>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end p-3" id="featuredImageDropdownMenu" style="width: 400px; max-height: 400px; overflow-y: auto;" data-bs-auto-close="outside">
                        <li>
                          <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading images...</div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <% if (item && item.featuredImage) { %>
                      <input type="hidden" id="featuredImageInput" name="featuredImage" value="<%= item.featuredImage._id %>">
                    <% } else { %>
                      <input type="hidden" id="featuredImageInput" name="featuredImage" value="">
                    <% } %>
                  </div>
                  <div id="featuredImagePreview" class="mt-3">
                    <% if (item && item.featuredImage) { %>
                      <label class="form-label">Selected Image Preview</label>
                      <img src="/admin/media/image/<%= item.featuredImage._id %>/thumbnail" class="img-thumbnail mb-2" style="width: 100%;">
                    <% } else { %>
                      <label class="form-label">Selected Image Preview</label>
                      <div class="text-muted text-center py-3 border rounded" style="background-color: #f8f9fa;">
                        No image selected
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="card mb-3">
                <div class="card-body">
                  <h5>Project Images</h5>
                  <div id="imagesPreview" class="mb-2">
                    <% if (item && item.images && item.images.length > 0) { %>
                      <% item.images.forEach(image => { %>
                        <div class="position-relative d-inline-block me-2 mb-2">
                          <img src="/admin/media/image/<%= image._id %>/thumbnail" class="img-thumbnail" style="width: 100px;">
                          <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeImage('<%= image._id %>')">√ó</button>
                          <input type="hidden" name="images" value="<%= image._id %>">
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                  <button type="button" class="btn btn-primary btn-sm w-100" onclick="selectMedia('images')">Add Images</button>
                </div>
              </div>
              <button type="submit" class="btn btn-success w-100">Save</button>
            </div>
          </div>
        </form>
      </main>
    </div>
  </div>

  <div class="modal fade" id="mediaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Media</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="mediaModalBody"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Mobile sidebar toggle functionality
    (function() {
      const sidebar = document.getElementById('adminSidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      
      function openSidebar() {
        sidebar.classList.add('show');
        sidebarOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSidebar() {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
      }
      
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', openSidebar);
      }
      
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }
      
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }
      
      // Close sidebar when clicking on a link (mobile only)
      if (window.innerWidth <= 767.98) {
        const sidebarLinks = sidebar.querySelectorAll('a');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', closeSidebar);
        });
      }
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth > 767.98) {
          closeSidebar();
        }
      });
    })();
    
    let currentMediaType = '';
    let mediaList = [];

    // Load media list on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadMediaList();
      setupFeaturedImageDropdown();
    });

    function getFeaturedImageDropdown() {
      const dropdownElement = document.getElementById('featuredImageDropdown');
      if (!dropdownElement) return null;
      
      // Get existing instance or create new one
      let dropdownInstance = bootstrap.Dropdown.getInstance(dropdownElement);
      if (!dropdownInstance) {
        dropdownInstance = new bootstrap.Dropdown(dropdownElement);
      }
      return dropdownInstance;
    }

    function loadMediaList() {
      console.log('Loading media list...');
      fetch('/admin/media/list')
        .then(res => {
          console.log('Media list response status:', res.status);
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('Media list data received:', data);
          if (data.success && data.media) {
            mediaList = data.media;
            console.log('Media list loaded, count:', mediaList.length);
            populateFeaturedImageDropdown();
          } else {
            console.error('Media list response invalid:', data);
            const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
            if (dropdownMenu) {
              dropdownMenu.innerHTML = '<li><div class="text-center text-muted py-3">No images available</div></li>';
            }
          }
        })
        .catch(error => {
          console.error('Error loading media list:', error);
          const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
          if (dropdownMenu) {
            dropdownMenu.innerHTML = '<li><div class="text-center text-danger py-3">Error loading images. Please refresh the page.</div></li>';
          }
        });
    }

    function populateFeaturedImageDropdown() {
      console.log('Populating featured image dropdown, mediaList length:', mediaList.length);
      const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
      
      if (!dropdownMenu) {
        console.error('Dropdown menu element not found!');
        return;
      }
      
      <% if (item && item.featuredImage) { %>
      const currentValue = '<%= item.featuredImage._id %>';
      <% } else { %>
      const currentValue = '';
      <% } %>
      
      if (mediaList.length === 0) {
        console.log('No media items to display');
        dropdownMenu.innerHTML = '<li><div class="text-center text-muted py-3">No images available in media library</div></li>';
        return;
      }
      
      console.log('Populating dropdown with', mediaList.length, 'images');
      
      // Create grid of image thumbnails
      dropdownMenu.innerHTML = '<li><div class="row g-2"></div></li>';
      const grid = dropdownMenu.querySelector('.row');
      
      mediaList.forEach(media => {
        const col = document.createElement('div');
        col.className = 'col-6';
        
        const card = document.createElement('div');
        card.className = 'card position-relative';
        if (media._id === currentValue) {
          card.classList.add('border-primary', 'border-2');
        }
        card.style.cursor = 'pointer';
        card.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          selectFeaturedImage(media._id);
          // Close dropdown
          const dropdown = getFeaturedImageDropdown();
          if (dropdown) dropdown.hide();
        };
        
        const img = document.createElement('img');
        img.src = `/admin/media/image/${media._id}/thumbnail`;
        img.className = 'card-img-top';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        img.alt = media.title || media.originalName || 'Image';
        img.onerror = function() {
          this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect width="100" height="100" fill="%23ddd"/%3E%3Ctext x="50" y="50" text-anchor="middle" dy=".3em" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';
        };
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-2';
        
        const title = document.createElement('p');
        title.className = 'card-text small text-truncate mb-0';
        title.textContent = media.title || media.originalName || 'Image';
        title.style.fontSize = '0.75rem';
        
        cardBody.appendChild(title);
        card.appendChild(img);
        card.appendChild(cardBody);
        
        // Add checkmark for selected image
        if (media._id === currentValue) {
          const checkmark = document.createElement('div');
          checkmark.className = 'position-absolute top-0 end-0 bg-primary text-white rounded-circle m-1';
          checkmark.style.width = '24px';
          checkmark.style.height = '24px';
          checkmark.style.display = 'flex';
          checkmark.style.alignItems = 'center';
          checkmark.style.justifyContent = 'center';
          checkmark.style.fontSize = '14px';
          checkmark.innerHTML = '‚úì';
          card.appendChild(checkmark);
        }
        
        col.appendChild(card);
        grid.appendChild(col);
      });
    }

    function selectFeaturedImage(mediaId) {
      const input = document.getElementById('featuredImageInput');
      const preview = document.getElementById('featuredImagePreview');
      const buttonText = document.getElementById('featuredImageButtonText');
      
      // Find the selected media item
      const selectedMedia = mediaList.find(m => m._id === mediaId);
      const mediaName = selectedMedia ? (selectedMedia.title || selectedMedia.originalName || 'Image') : 'Image';
      
      input.value = mediaId;
      buttonText.textContent = `Selected: ${mediaName}`;
      
      // Update preview
      fetch(`/admin/media/image/${mediaId}/thumbnail`)
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          preview.innerHTML = `
            <label class="form-label">Selected Image Preview</label>
            <img src="${url}" class="img-thumbnail mb-2" style="width: 100%;">
          `;
          
          // Update visual selection in dropdown grid
          const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
          const cards = dropdownMenu.querySelectorAll('.card');
          cards.forEach(card => {
            card.classList.remove('border-primary', 'border-2');
            const checkmark = card.querySelector('.position-absolute.top-0.end-0.bg-primary');
            if (checkmark) checkmark.remove();
          });
          
          // Find and highlight selected card
          cards.forEach(card => {
            const img = card.querySelector('img');
            if (img && img.src.includes(mediaId)) {
              card.classList.add('border-primary', 'border-2');
              const checkmark = document.createElement('div');
              checkmark.className = 'position-absolute top-0 end-0 bg-primary text-white rounded-circle m-1';
              checkmark.style.width = '24px';
              checkmark.style.height = '24px';
              checkmark.style.display = 'flex';
              checkmark.style.alignItems = 'center';
              checkmark.style.justifyContent = 'center';
              checkmark.style.fontSize = '14px';
              checkmark.innerHTML = '‚úì';
              card.appendChild(checkmark);
            }
          });
        })
        .catch(error => {
          console.error('Error loading image preview:', error);
        });
    }

    function setupFeaturedImageDropdown() {
      // Ensure dropdown menu stays open when clicking inside it
      const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
      const dropdownButton = document.getElementById('featuredImageDropdown');
      
      if (dropdownMenu && dropdownButton) {
        // Prevent dropdown from closing when clicking inside the menu
        dropdownMenu.addEventListener('click', function(e) {
          // Allow clicks on cards to work, but prevent dropdown from closing until selection
          if (e.target.closest('.card')) {
            e.stopPropagation();
          }
        });

        // Ensure dropdown can open even if content is still loading
        dropdownButton.addEventListener('shown.bs.dropdown', function() {
          console.log('Dropdown opened, mediaList length:', mediaList.length);
          // If media list hasn't loaded yet or is empty, trigger a load
          const dropdownMenu = document.getElementById('featuredImageDropdownMenu');
          if (!dropdownMenu) {
            console.error('Dropdown menu not found when opening');
            return;
          }
          
          // Check if we're still showing the loading spinner
          const isLoading = dropdownMenu.querySelector('.spinner-border');
          if (isLoading || mediaList.length === 0) {
            console.log('Reloading media list...');
            loadMediaList();
          }
        });

        // Fallback: Ensure dropdown works even if Bootstrap auto-initialization fails
        // Wait a bit for Bootstrap to initialize, then verify
        setTimeout(function() {
          const dropdownInstance = bootstrap.Dropdown.getInstance(dropdownButton);
          if (!dropdownInstance && typeof bootstrap !== 'undefined') {
            // Manually initialize if not already initialized
            new bootstrap.Dropdown(dropdownButton);
          }
        }, 100);
      }
    }

    function selectMedia(type) {
      currentMediaType = type;
      fetch('/admin/media/modal').then(res => res.text()).then(html => {
        document.getElementById('mediaModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('mediaModal')).show();
      });
    }
    function selectImage(mediaId) {
      if (currentMediaType === 'featuredImage') {
        selectFeaturedImage(mediaId);
      } else {
        const imagesPreview = document.getElementById('imagesPreview');
        fetch(`/admin/media/image/${mediaId}/thumbnail`).then(res => res.blob()).then(blob => {
          const url = URL.createObjectURL(blob);
          const div = document.createElement('div');
          div.className = 'position-relative d-inline-block me-2 mb-2';
          div.innerHTML = `<img src="${url}" class="img-thumbnail" style="width: 100px;"><button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeImage('${mediaId}')">√ó</button><input type="hidden" name="images" value="${mediaId}">`;
          imagesPreview.appendChild(div);
        });
      }
      bootstrap.Modal.getInstance(document.getElementById('mediaModal')).hide();
    }
    function removeImage(mediaId) {
      document.getElementById('imagesPreview').querySelectorAll('div').forEach(div => {
        if (div.querySelector(`input[value="${mediaId}"]`)) div.remove();
      });
    }

    // Form submission debugging and handling
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form');
      if (!form) {
        console.error('‚ùå Form element not found!');
        return;
      }
      
      console.log('üîµ Form found, action:', form.action, 'method:', form.method);
      
      form.addEventListener('submit', function(e) {
        console.log('üîµüîµüîµ FORM SUBMIT EVENT FIRED üîµüîµüîµ');
        console.log('üîµ Form action:', form.action);
        console.log('üîµ Form method:', form.method);
        
        // Handle empty featuredImage - ensure it's submitted as empty string (server will convert to null)
        const featuredImageInput = document.getElementById('featuredImageInput');
        if (featuredImageInput) {
          if (!featuredImageInput.value || featuredImageInput.value.trim() === '') {
            featuredImageInput.value = ''; // Ensure it's empty string
            console.log('üîµ Featured image is empty');
          } else {
            console.log('üîµ Featured image ID:', featuredImageInput.value);
          }
          // Always ensure the name attribute is set
          if (!featuredImageInput.name) {
            featuredImageInput.name = 'featuredImage';
          }
        }
        
        // Log form data before submission
        const formData = new FormData(form);
        console.log('üîµ Form data being submitted:');
        for (let [key, value] of formData.entries()) {
          console.log('  -', key + ':', value);
        }
        
        console.log('üîµ Allowing form to submit normally...');
        // Don't prevent default - let form submit normally (HTML5 validation will handle required fields)
      });
    });
  </script>
</body>
</html>

